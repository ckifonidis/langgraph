# Functional Specification Document

## 1. Input Parameters
- `catalog`: The catalog name derived from the `get_catalog()` function.
- `partition_conditions`: Conditions for partition range derived from the `get_pardt_range_condition()` function.
- `merchant_user_id_condition`: Conditions for merchant user ID derived from the `parse_merchant_condition("merchant_user_id")` function.
- `merchant_user_id_condition_promotions`: Conditions for merchant user ID specifically for promotions derived from the `parse_merchant_condition("p.merchant_id")` function.

## 2. Source Tables
Here are the source tables relevant to the queries executed in the notebook:

### Source Table: merchant_insights_customer
| Column Name     | Column Data Type |
|:----------------|:-----------------|
| merchant_user_id| STRING           |
| par_dt          | DATE             |
| customer_id     | STRING           |
| promotion_id    | STRING           |

### Source Table: mpe_promotion_customers
| Column Name     | Column Data Type |
|:----------------|:-----------------|
| promotion_id    | STRING           |
| customercode    | STRING           |

### Source Table: mpe_promotions
| Column Name     | Column Data Type |
|:----------------|:-----------------|
| merchant_id     | STRING           |
| promotion_id    | STRING           |

## 3. Intermediate Tables
No explicit CTEs (Common Table Expressions) are created in the provided notebook. The logic for creating intermediate tables is embedded directly within the main SQL queries.

## 4. Target Tables
The following target table is updated or generated by the queries in the notebook:

### Target Table: analytics_conversion_rate
| Target Table                                     | Source Table                                | Row Selection Logic                                         |
|:------------------------------------------------|:-------------------------------------------|:-----------------------------------------------------------|
| analytics_conversion_rate                        | merchant_promotion_analytical.merchant_insights_customer | where {partition_conditions} and promotion_id is not null {merchant_user_id_condition} |
| analytics_conversion_rate                        | merchant_promotion_engine.mpe_promotion_customers | where par_dt = -1 {merchant_user_id_condition}             |

### Target Table Columns:
| Target Column       | Data Type | Transformation Logic  | Source Table                                         | Source Column         |
|:--------------------|:----------|:----------------------|:-----------------------------------------------------|:----------------------|
| tbl                 | STRING    | 'insights'            | bdprod.merchant_promotion_analytical.merchant_insights_customer | 'insights'            |
| merchant_user_id    | STRING    | Direct Copy           | bdprod.merchant_promotion_analytical.merchant_insights_customer | merchant_user_id      |
| par_dt              | DATE      | Direct Copy           | bdprod.merchant_promotion_analytical.merchant_insights_customer | par_dt                |
| customer_id         | STRING    | Direct Copy           | bdprod.merchant_promotion_analytical.merchant_insights_customer | customer_id           |
| promotion_id        | STRING    | lower(promotion_id)   | bdprod.merchant_promotion_analytical.merchant_insights_customer | promotion_id          |

| Target Column       | Data Type | Transformation Logic  | Source Table                                         | Source Column         |
|:--------------------|:----------|:----------------------|:-----------------------------------------------------|:----------------------|
| tbl                 | STRING    | 'promotions'          | bdprod.merchant_promotion_engine.mpe_promotions     | 'promotions'          |
| merchant_user_id    | STRING    | Direct Copy           | bdprod.merchant_promotion_engine.mpe_promotions     | merchant_id           |
| par_dt              | INT       | -1                    | N/A                                                  | N/A                   |
| customer_id         | STRING    | Direct Copy           | bdprod.merchant_promotion_engine.mpe_promotion_customers | customercode         |
| promotion_id        | STRING    | lower(promotion_id)   | bdprod.merchant_promotion_engine.mpe_promotions     | promotion_id          |
```
